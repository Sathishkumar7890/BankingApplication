/**
 * Last generated by Orchestration Designer at: 2026-FEB-01  08:11:52 PM
 */
package english.prompts;

import com.avaya.sce.runtime.tracking.TraceInfo;
import com.avaya.sce.runtimecommon.ITraceInfo;
import com.avaya.sce.runtimecommon.SCESession;

import flow.IProjectVariables;

public class DynamicPrompt extends com.avaya.sce.runtime.Prompt {

	//{{START:CLASS:FIELDS
	//}}END:CLASS:FIELDS

	/**
	 * Constructor for DynamicPrompt.
	 */
	public DynamicPrompt() {
		//{{START:CLASS:CONSTRUCTOR
		super();
		//}}END:CLASS:CONSTRUCTOR
	}


	/**
	 * This method is generated automatically and should not be manually edited
	 * To manually edit the prompt, override:
	 * void updatePrompt()
	 * Last generated by Orchestration Designer at: 2026-FEB-20  11:52:55 AM
	 */
	public void buildPrompt(){
		com.avaya.sce.runtime.Format format = null;
		com.avaya.sce.runtime.RenderHint hint = null;
		com.avaya.sce.runtime.MediaPage mediaPage = null;
		setBarginType(com.avaya.sce.runtimecommon.SCERT.BARGIN_SPEECH);
		setName("DynamicPrompt");
		setOrder(com.avaya.sce.runtime.Prompt.STANDARD);

		// Prompt level 1
		setTimeout(1,8000);
		setBargin(1,true);

	}
	@Override
	public void updatePrompt(SCESession mySession) {

	    setTimeout(1, 8000);
	    setBargin(1, true);
	    
        com.avaya.sce.runtime.Format format = new com.avaya.sce.runtime.Format();
        format.add("format", "character");
        format.add("inflection", "Cn");
	    
	    String nextNode = mySession.getVariableField(IProjectVariables.NODE_DETAILS,IProjectVariables.NODE_DETAILS_FIELD_DESCRIPTION).getStringValue();
	    boolean has_banking = mySession.getVariableField(IProjectVariables.FLAG,IProjectVariables.FLAG_FIELD_HAS_BANKING).getBooleanValue();
	    boolean has_credit  = mySession.getVariableField(IProjectVariables.FLAG,IProjectVariables.FLAG_FIELD_HAS_CREDIT).getBooleanValue();
	    
	    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "PROMPT NEXT NODE : " + nextNode, mySession);


	    int promptCount = mySession.getVariableField(
	            IProjectVariables.PROMPT_URL,
	            IProjectVariables.PROMPT_URL_FIELD_PROMPT_COUNT
	    ).getIntValue();

	    // Check DTMF input from Language Menu
	    String CustomerSelectedLng= mySession.getVariableField(IProjectVariables.NODE_DETAILS,IProjectVariables.NODE_DETAILS_FIELD_LANGUAGE).getStringValue();

	    // Determine current language
	    String language = "";
	    String currentLanguage = ""; // Default
	    if ("EN".equals(CustomerSelectedLng)) {
	        currentLanguage = "EN";
	        language = "EN";
	    } else if ("HI".equals(CustomerSelectedLng)) {
	        currentLanguage = "HI";
	        language = "HI";
	    } else {
	        // If DTMF not yet entered, use preferred language
	        String preferredLanguage = mySession.getVariableField(
	                IProjectVariables.NODE_DETAILS,
	                IProjectVariables.NODE_DETAILS_FIELD_PREFERRED_LANGUAGE
	        ).getStringValue();
	        if (preferredLanguage != null) {
	            currentLanguage = preferredLanguage;
	            language = preferredLanguage;
	        }
	    }

	    // Store selected language for future use
//	    mySession.getVariableField(IProjectVariables.NODE_DETAILS,IProjectVariables.NODE_DETAILS_FIELD_SELECTED_LANGUAGE
//	    ).setValue(currentLanguage);

	    String baseURLEng = mySession.getVariableField(
	            IProjectVariables.PROMPT_URL,
	            IProjectVariables.PROMPT_URL_FIELD_ENG_BASE_URL
	    ).getStringValue();

	    String baseURLHin = mySession.getVariableField(
	            IProjectVariables.PROMPT_URL,
	            IProjectVariables.PROMPT_URL_FIELD_HINDI_BASE_URL
	    ).getStringValue();
	    
	    mySession.getVariableField(IProjectVariables.CALL_HISTORY, IProjectVariables.CALL_HISTORY_FIELD_LANGUAGE).setValue(language);

	    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "Current Language : " + currentLanguage, mySession);
	    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "TOTAL PROMPT COUNT : " + promptCount, mySession);
	    
        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "HAS_CREDIT : "+has_credit, mySession);
        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "HAS_BANKING : "+has_banking, mySession);
        
if ("MAIN_MENU".equals(nextNode)) {
            
            TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "****ENTERED INTO MAIN_MENU****", mySession);
            mySession.getVariableField(IProjectVariables.PRESS_1).setValue("1");
	        mySession.getVariableField(IProjectVariables.PRESS_2).setValue("2");
	        mySession.getVariableField(IProjectVariables.PRESS_3).setValue("3");

            // Get base URL
            String URL = mySession.getVariableField(
                    IProjectVariables.PROMPT_URL,
                    IProjectVariables.PROMPT_URL_FIELD_BASE_URL
            ).getStringValue();

            for (int i = 0; i < promptCount; i++) {
                // Handle MAIN_MENU prompt logic based on services available
                if (has_credit && has_banking) {

                    String Prompt_1 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).getStringValue();
                    String Prompt_2 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).getStringValue();
                    String Prompt_3 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).getStringValue();

                    // ✅ Check if already full path
                    String PromptLocation1 = (Prompt_1 != null && Prompt_1.startsWith("/PromptFiles/")) ? Prompt_1 : URL + Prompt_1;
                    String PromptLocation2 = (Prompt_2 != null && Prompt_2.startsWith("/PromptFiles/")) ? Prompt_2 : URL + Prompt_2;
                    String PinServices   = (Prompt_3 != null && Prompt_3.startsWith("/PromptFiles/")) ? Prompt_3 : URL + Prompt_3;

                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "MAIN_MENU PROMPT URL " + PromptLocation1, mySession);
                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "MAIN_MENU PROMPT URL " + PromptLocation2, mySession);
                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "PIN_SERVICES PROMPT URL " + PinServices, mySession);

                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).setValue(PromptLocation1);
                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).setValue(PromptLocation2);
                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).setValue(PinServices);

                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_1", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press1",format,false));
                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_2", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press2",format,false));
                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_3", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press3",format,false));
                    
                    break;

                } else if (has_credit) {

                    String Prompt_2 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).getStringValue();
                    String Prompt_3 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).getStringValue();

                    String PromptLocation = (Prompt_2 != null && Prompt_2.startsWith("/PromptFiles/")) ? Prompt_2 : URL + Prompt_2;
                    String PinServices   = (Prompt_3 != null && Prompt_3.startsWith("/PromptFiles/")) ? Prompt_3 : URL + Prompt_3;

                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "MAIN_MENU PROMPT URL " + PromptLocation, mySession);
                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "PIN_SERVICES PROMPT URL " + PinServices, mySession);

                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).setValue(PromptLocation);
                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).setValue(PinServices);

                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_2", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press1",format,false));
                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_3", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press2",format,false));

                    break;

                } else if (has_banking) {

                    String Prompt_1 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).getStringValue();
                    String Prompt_3 = mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).getStringValue();

                    String PromptLocation = (Prompt_1 != null && Prompt_1.startsWith("/PromptFiles/")) ? Prompt_1 : URL + Prompt_1;
                    String PinServices   = (Prompt_3 != null && Prompt_3.startsWith("/PromptFiles/")) ? Prompt_3 : URL + Prompt_3;

                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "MAIN_MENU PROMPT URL " + PromptLocation, mySession);
                    TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "PIN_SERVICES PROMPT URL " + PinServices, mySession);

                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).setValue(PromptLocation);
                    mySession.getVariableField(IProjectVariables.PROMPT_URL, IProjectVariables.PROMPT_URL_FIELD_PROMPT___3).setValue(PinServices);

                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_1", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press1",format,false));
                    add(1, new com.avaya.sce.runtime.PhraseVariableElement("PromptURL:Prompt_3", com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    add(1, new com.avaya.sce.runtime.PromptElement(com.avaya.sce.runtime.PromptElement.VARIABLE_AUDIO,"Press2",format,false));

                    break;

                } else { // No services, just play the default prompt

                    String setPrompt = "Prompt_" + (i + 1);
                    String promptFile = mySession.getVariableField(IProjectVariables.PROMPT_URL, setPrompt).getStringValue();

                    if (promptFile != null && !promptFile.trim().isEmpty()) {
                        String fullPrompt = promptFile.startsWith("/PromptFiles/") ? promptFile : URL + promptFile;
                        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO, "PROMPT URL " + fullPrompt, mySession);
                        mySession.getVariableField(IProjectVariables.PROMPT_URL, setPrompt).setValue(fullPrompt);

                        add(1, new com.avaya.sce.runtime.PhraseVariableElement(
                                "PromptURL:Prompt_" + (i + 1),
                                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
                    }
                }
                
       }
            super.updatePrompt(mySession);
        }else if ("COLLECT_OTP".equals(nextNode)) {
 
	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,

	                "ENTERED INTO THE OTP BLOCK ! ", mySession);
 
	        int count = mySession.getVariableField(

	                IProjectVariables.GENERATE_OTP,

	                IProjectVariables.GENERATE_OTP_FIELD_COUNT).getIntValue();
 
	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,

	                "GENERATE COUNT :" + count, mySession);
 
	        String baseUrl = mySession.getVariableField(

	                IProjectVariables.PROMPT_URL,

	                IProjectVariables.PROMPT_URL_FIELD_BASE_URL).getStringValue();
 
	        if (baseUrl != null && !baseUrl.endsWith("/")) {

	            baseUrl = baseUrl + "/";

	        }
 
	        /* =========================

	           PROMPT 1

	           ========================= */
 
	        String prompt1 = mySession.getVariableField(

	                IProjectVariables.PROMPT_URL,

	                IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).getStringValue();
 
	        // Prevent double concatenation

	        if (!prompt1.startsWith(baseUrl)) {

	            prompt1 = baseUrl + prompt1;
 
	            mySession.getVariableField(

	                    IProjectVariables.PROMPT_URL,

	                    IProjectVariables.PROMPT_URL_FIELD_PROMPT___1).setValue(prompt1);

	        }
 
	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,

	                "URL 1 : " + prompt1, mySession);
 
	        add(1, new com.avaya.sce.runtime.PhraseVariableElement(

	                "PromptURL:Prompt_1",

	                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
 
	        /* =========================

	           PROMPT 2 (First Time Only)

	           ========================= */
 
	        if (count == 0) {
 
	            String prompt2 = mySession.getVariableField(

	                    IProjectVariables.PROMPT_URL,

	                    IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).getStringValue();
 
	            if (!prompt2.startsWith(baseUrl)) {

	                prompt2 = baseUrl + prompt2;
 
	                mySession.getVariableField(

	                        IProjectVariables.PROMPT_URL,

	                        IProjectVariables.PROMPT_URL_FIELD_PROMPT___2).setValue(prompt2);

	            }
 
	            TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,

	                    "URL 2 : " + prompt2, mySession);
 
	            add(1, new com.avaya.sce.runtime.PhraseVariableElement(

	                    "PromptURL:Prompt_2",

	                    com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
 
	            count++;

	            mySession.getVariableField(

	                    IProjectVariables.GENERATE_OTP,

	                    IProjectVariables.GENERATE_OTP_FIELD_COUNT).setValue(count);

	        }


	    }
 else {
	    	// ✅ Set default language (VERY_IMPORTANT)
	    	if (currentLanguage == null || currentLanguage.trim().isEmpty()) {
	    	    currentLanguage = "EN";
	    	}

	    	// ✅ Set BASE URL only ONCE (NOT inside loop)
	    	if ("HI".equalsIgnoreCase(currentLanguage)) {
	    	    mySession.getVariableField(
	    	            IProjectVariables.PROMPT_URL,
	    	            IProjectVariables.PROMPT_URL_FIELD_BASE_URL
	    	    ).setValue(baseURLHin);
	    	    
	    	} else {
	    	    mySession.getVariableField(
	    	            IProjectVariables.PROMPT_URL,
	    	            IProjectVariables.PROMPT_URL_FIELD_BASE_URL
	    	    ).setValue(baseURLEng);
	    	}

	    	for (int i = 0; i < promptCount; i++) {

	    	    String setPrompt = "Prompt_" + (i + 1);

	    	    String promptFile = mySession.getVariableField(
	    	            IProjectVariables.PROMPT_URL,
	    	            setPrompt
	    	    ).getStringValue();

	    	    // ✅ Null Safety
	    	    if (promptFile == null || promptFile.trim().isEmpty()) {
	    	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_WARN,
	    	                "Prompt file is NULL for " + setPrompt, mySession);
	    	        continue;
	    	    }

	    	    // ✅ Prevent duplicate URL concatenation
	    	    boolean alreadyFullPath = promptFile.startsWith("/PromptFiles/");

	    	    if ("EN".equalsIgnoreCase(currentLanguage)) {

	    	        String fullPrompt = alreadyFullPath
	    	                ? promptFile
	    	                : baseURLEng + promptFile;
	    	        mySession.setProperty("BASE_URL", baseURLEng);

	    	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,
	    	                "PROMPT URL: " + fullPrompt, mySession);

	    	        mySession.getVariableField(
	    	                IProjectVariables.PROMPT_URL,
	    	                setPrompt
	    	        ).setValue(fullPrompt);

	    	        add(1, new com.avaya.sce.runtime.PhraseVariableElement(
	    	                "PromptURL:Prompt_" + (i + 1),
	    	                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));

	    	    }
	    	    else if ("HI".equalsIgnoreCase(currentLanguage)) {

	    	        String fullPrompt = alreadyFullPath
	    	                ? promptFile
	    	                : baseURLHin + promptFile;

	    	        TraceInfo.trace(ITraceInfo.TRACE_LEVEL_INFO,
	    	                "PROMPT URL: " + fullPrompt, mySession);
	    	        mySession.setProperty("BASE_URL", baseURLHin);

	    	        mySession.getVariableField(
	    	                IProjectVariables.PROMPT_HIN_URL,
	    	                setPrompt
	    	        ).setValue(fullPrompt);

	    	        add(1, new com.avaya.sce.runtime.PhraseVariableElement(
	    	                "PromptHinURL:Prompt_" + (i + 1),
	    	                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
	    	    }
	    	    else {

	    	        // ⭐ Unknown language → play BOTH safely

	    	        String fullPromptEng = alreadyFullPath
	    	                ? promptFile
	    	                : baseURLEng + promptFile;

	    	        mySession.getVariableField(
	    	                IProjectVariables.PROMPT_URL,
	    	                setPrompt
	    	        ).setValue(fullPromptEng);

	    	        add(1, new com.avaya.sce.runtime.PhraseVariableElement(
	    	                "PromptURL:Prompt_" + (i + 1),
	    	                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));


	    	        String fullPromptHin = alreadyFullPath
	    	                ? promptFile
	    	                : baseURLHin + promptFile;

	    	        mySession.getVariableField(
	    	                IProjectVariables.PROMPT_HIN_URL,
	    	                setPrompt
	    	        ).setValue(fullPromptHin);

	    	        add(1, new com.avaya.sce.runtime.PhraseVariableElement(
	    	                "PromptHinURL:Prompt_" + (i + 1),
	    	                com.avaya.sce.runtime.PhraseVariableElement.Type.AUDIO_URL));
	    	    }
	    	}

	    }
	    
	    super.updatePrompt(mySession);
	}
}
